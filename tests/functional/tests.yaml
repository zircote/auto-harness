---
# auto-harness Meta-Test Suite
# Tests the plugin using its own hook-driven testing patterns
# Following the same concrete action pattern as subcog tests

version: "1.0"
description: "auto-harness Plugin Functional Test Suite"
generated_by: auto-harness

tests:
  # ============================================================================
  # Smoke Tests - Verify basic plugin and runner functionality
  # ============================================================================

  - id: smoke_runner_executable
    description: Verify runner.sh is executable and responds to help
    category: smoke
    action: |
      Run: ./tests/functional/runner.sh --help
      Report the available commands listed.
    expect:
      - contains: "init"
      - contains: "next"
      - contains: "validate"
    tags: [smoke, critical]

  - id: smoke_state_directory
    description: Verify .claude directory exists for state storage
    category: smoke
    action: |
      Run: ls -la .claude/
      Report if the directory exists and is accessible.
    expect:
      - regex: "(test-state|hooks|total)"
      - not_contains: "No such file"
    tags: [smoke, state]

  # ============================================================================
  # Runner Command Tests - Test each runner.sh command
  # ============================================================================

  - id: runner_state_file_exists
    description: Test that test-state.json exists after init
    category: runner
    action: |
      Run: cat .claude/test-state.json | head -5
      Report if state file exists with valid JSON structure.
    expect:
      - contains: "mode"
      - regex: "(running|total_tests)"
    tags: [runner, init, critical]

  - id: runner_status_shows_progress
    description: Test that runner status shows current test progress
    category: runner
    action: |
      Run: ./tests/functional/runner.sh status
      Report the current test position and counts.
    expect:
      - regex: "(Test|tests|progress)"
      - regex: "[0-9]+"
    tags: [runner, status]

  - id: runner_next_returns_test
    description: Test that runner next returns test details
    category: runner
    action: |
      Run: ./tests/functional/runner.sh next
      Report the test ID and action returned.
    expect:
      - contains: "Test"
      - regex: "(Action|action|description)"
    tags: [runner, next]

  # ============================================================================
  # Template Validation Tests - Verify template files are correct
  # ============================================================================

  - id: template_runner_valid
    description: Verify runner.sh template contains required functions
    category: templates
    action: |
      Run: grep -c "cmd_init\|cmd_next\|cmd_validate\|cmd_status" templates/runner/runner.sh
      Report the count of required functions found.
    expect:
      - regex: "[4-9]|[1-9][0-9]"
      - not_contains: "0"
    tags: [templates, runner]

  - id: template_hooks_valid
    description: Verify hooks.json template has UserPromptSubmit hook
    category: templates
    action: |
      Run: cat templates/hooks/hooks.json
      Report if UserPromptSubmit hook is configured.
    expect:
      - contains: "UserPromptSubmit"
      - contains: "test-wrapper.sh"
    tags: [templates, hooks]

  - id: template_tests_yaml_valid
    description: Verify tests.yaml template has correct structure
    category: templates
    action: |
      Run: head -30 templates/tests/tests.yaml
      Report if it contains version and tests array.
    expect:
      - contains: "version"
      - contains: "tests"
    tags: [templates, tests]

  # ============================================================================
  # Plugin Structure Tests - Verify complete plugin organization
  # ============================================================================

  - id: structure_plugin_manifest
    description: Verify plugin.json manifest is valid JSON with required fields
    category: structure
    action: |
      Run: python3 -c "import json; d=json.load(open('.claude-plugin/plugin.json')); print(f'name={d[\"name\"]} version={d[\"version\"]}')"
      Report the plugin name and version.
    expect:
      - contains: "auto-harness"
      - regex: "version=[0-9]"
    tags: [structure, manifest, critical]

  - id: structure_commands_directory
    description: Verify commands directory has required command files
    category: structure
    action: |
      Run: ls -1 .claude/commands/
      Report the command files found.
    expect:
      - regex: "(init|validate|run-tests)"
    tags: [structure, commands]

  - id: structure_skills_directory
    description: Verify skills directory exists with skill files
    category: structure
    action: |
      Run: ls -1 .claude-plugin/skills/ 2>/dev/null || echo "no skills directory"
      Report what skill files exist.
    expect:
      - regex: "(skill|.md|no skills)"
    tags: [structure, skills]

  - id: structure_agents_directory
    description: Verify agents directory exists with agent files
    category: structure
    action: |
      Run: ls -1 .claude-plugin/agents/ 2>/dev/null || echo "no agents directory"
      Report what agent files exist.
    expect:
      - regex: "(agent|.md|no agents)"
    tags: [structure, agents]

  # ============================================================================
  # Meta-Test Validation - Test the test framework itself
  # ============================================================================

  - id: meta_validate_pass
    description: Test that validate correctly identifies passing response
    category: meta
    action: |
      Run: ./tests/functional/runner.sh validate "This test passed successfully with init and next and validate"
      Report the validation result.
    expect:
      - regex: "(PASS|pass|success)"
    tags: [meta, validate]

  - id: meta_state_json_valid
    description: Test that test-state.json is valid JSON after operations
    category: meta
    action: |
      Run: python3 -c "import json; d=json.load(open('.claude/test-state.json')); print(f'current_index={d.get(\"current_index\", \"N/A\")} total={len(d.get(\"filtered_tests\", []))}')"
      Report the state structure.
    expect:
      - contains: "current_index"
      - regex: "total=[0-9]+"
    tags: [meta, state]

  - id: meta_report_generation
    description: Test that report command generates valid markdown
    category: meta
    action: |
      Run: ./tests/functional/runner.sh report | head -20
      Report if markdown report was generated with summary table.
    expect:
      - contains: "Test Execution Report"
      - regex: "(Passed|Failed|Summary)"
    tags: [meta, report]
